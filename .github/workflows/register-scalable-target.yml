name: Register ECS Scalable Target (min=5)

on:
  workflow_dispatch:

jobs:
  register-scalable-target:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      CLUSTER: ${{ secrets.ECS_CLUSTER }}
      SERVICE: ${{ secrets.ECS_SERVICE }}
      MAX_CAPACITY: ${{ secrets.MAX_CAPACITY || '10' }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Show caller identity & region (safety)
        run: |
          aws sts get-caller-identity
          echo "Region: $AWS_REGION"

      - name: Register scalable target (min=5, max=${{ env.MAX_CAPACITY }})
        run: |
          echo "Registering scalable target for service/${CLUSTER}/${SERVICE} ..."
          aws application-autoscaling register-scalable-target \
            --service-namespace ecs \
            --resource-id "service/${CLUSTER}/${SERVICE}" \
            --scalable-dimension ecs:service:DesiredCount \
            --min-capacity 5 \
            --max-capacity "${MAX_CAPACITY}" \
            --region "$AWS_REGION"

      - name: Describe scalable target (verify)
        run: |
          echo "Describe scalable targets:"
          aws application-autoscaling describe-scalable-targets \
            --service-namespace ecs \
            --resource-id "service/${CLUSTER}/${SERVICE}" \
            --scalable-dimension ecs:service:DesiredCount \
            --region "$AWS_REGION" --output table || true
