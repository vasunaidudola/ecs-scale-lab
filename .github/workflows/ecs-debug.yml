name: "ECS DEBUG"

on:
  workflow_dispatch:

jobs:
  debug-ecs:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      CLUSTER: ${{ secrets.ECS_CLUSTER }}
      SERVICE: ${{ secrets.ECS_SERVICE }}

    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: 1. Show region
        run: echo "Region = $AWS_REGION"

      - name: 2. Check cluster
        run: |
          echo "Cluster details:"
          aws ecs describe-clusters \
            --clusters "$CLUSTER" \
            --region "$AWS_REGION" \
            --output table || true

      - name: 3. Check service exists
        run: |
          echo "Service details:"
          aws ecs describe-services \
            --cluster "$CLUSTER" \
            --services "$SERVICE" \
            --query "services[0]" \
            --region "$AWS_REGION" \
            --output json || true

      - name: 4. Print taskDefinition the service uses
        run: |
          echo "Service Task Definition:"
          aws ecs describe-services \
            --cluster "$CLUSTER" \
            --services "$SERVICE" \
            --query "services[0].taskDefinition" \
            --region "$AWS_REGION" \
            --output text || true

      - name: 5. Print all deployments
        run: |
          echo "Deployments:"
          aws ecs describe-services \
            --cluster "$CLUSTER" \
            --services "$SERVICE" \
            --query "services[0].deployments" \
            --region "$AWS_REGION" \
            --output json || true

      - name: 6. List running tasks
        run: |
          echo "Tasks:"
          aws ecs list-tasks \
            --cluster "$CLUSTER" \
            --service-name "$SERVICE" \
            --region "$AWS_REGION" \
            --output text || true
